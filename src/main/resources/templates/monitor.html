<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          background: #f0f2f5;
          margin: 0;
          padding: 0;
        }

        header {
          background-color: #003366;
          color: white;
          padding: 20px;
          text-align: center;
          font-size: 24px;
        }

        .container {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 30px;
        }

        .section {
          background: white;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 30px;
          box-sizing: border-box;
        }

        .section h3 {
          margin-top: 0;
          color: #003366;
        }

        #device-section {
          width: 90%;
          max-width: 1000px;
        }

        #main-content {
          display: flex;
          flex-direction: row;
          gap: 30px;
          width: 90%;
          max-width: 1000px;
          flex-wrap: wrap;
        }

        #status-section {
          flex: 0 0 300px;
        }

        #chart-section {
          flex: 1;
          min-width: 0;
        }

        #chart-section canvas {
          width: 100% !important;
          height: auto !important;
        }

        select {
          font-size: 16px;
          padding: 8px 16px;
          width: 100%;
          max-width: 300px;
          margin-top: 10px;
        }

        .status {
          font-size: 20px;
          margin-top: 10px;
          display: block;
        }

        .status.safe { color: green; }
        .status.danger { color: red; }

        #detail-section {
          width: 90%;
          max-width: 1000px;
          background: white;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          border-radius: 12px;
          padding: 20px;
        }

        #detail-section h3 {
          color: #003366;
          margin-bottom: 10px;
        }

        #logTable {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        #logTable th, #logTable td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: center;
        }
        #logTable th {
          background-color: #f2f2f2;
          font-weight: bold;
        }
    </style>
</head>
<body>
<header>ì‹¤ì‹œê°„ ë°°í„°ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§</header>
<div class="container">

    <div class="section" id="device-section">
        <h3>ê¸°ê¸° ì„ íƒ</h3>
        <select id="deviceSelect">
            <option disabled selected>ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </div>

    <div id="main-content">
        <div class="section" id="status-section">
            <h3>ìƒì„¸ ìƒíƒœ</h3>
            <span id="currentStatus" class="status">ë°ì´í„° ë¡œë”© ì¤‘...</span>
            <span id="latestError" class="status"></span>
            <span id="latestThreshold" class="status"></span>
        </div>

        <div class="section" id="chart-section">
            <h3>Error ìˆ˜ì¹˜ ê·¸ë˜í”„</h3>
            <canvas id="errorChart"></canvas>
        </div>
    </div>

    <div class="section" id="detail-section">
        <h3>ê¸°ê¸° ìƒì„¸ ì •ë³´</h3>
        <div id="summaryInfo"></div>
        <table id="logTable">
            <thead>
            <tr>
                <th>ì‹œê°„</th>
                <th>ì—ëŸ¬</th>
                <th>ì´ìƒ ì—¬ë¶€</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
    const deviceSelect = document.getElementById("deviceSelect");
    const apiUrl = "/data";
    const deviceApiUrl = "/devices";
    const statusEl = document.getElementById("currentStatus");
    const errorEl = document.getElementById("latestError");
    const thresholdEl = document.getElementById("latestThreshold");
    const ctx = document.getElementById("errorChart").getContext("2d");
    const summaryEl = document.getElementById("summaryInfo");
    const logTableBody = document.querySelector("#logTable tbody");

    let availableDeviceIds = [];
    let chart;

    async function loadDeviceIds() {
      try {
        const res = await fetch(deviceApiUrl);
        if (!res.ok) throw new Error("ê¸°ê¸° ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
        const deviceIds = await res.json();

        availableDeviceIds = deviceIds;
        console.log("ğŸ“¡ ë°›ì€ ê¸°ê¸° ëª©ë¡:", deviceIds);

        while (deviceSelect.options.length > 1) {
          deviceSelect.remove(1);
        }

        deviceIds.forEach(id => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `ê¸°ê¸° ${id}`;
          deviceSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("ê¸°ê¸° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    }

    async function fetchData() {
      const selectedId = deviceSelect.value || availableDeviceIds[0];
      if (!selectedId) return;

      try {
        const res = await fetch(`${apiUrl}?deviceId=${selectedId}`);
        const data = await res.json();
        if (!data || data.length === 0) return;

        const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString()).reverse();
        const errors = data.map(d => d.error).reverse();
        const latest = data[0];

        // ìƒíƒœ í…ìŠ¤íŠ¸
        statusEl.textContent = latest.predict === 1 ? "ì´ìƒ ìƒíƒœ" : "ì •ìƒ";
        statusEl.className = latest.predict === 1 ? "status danger" : "status safe";
        errorEl.textContent = ` ì—ëŸ¬ ìˆ˜ì¹˜: ${latest.error}`;
        thresholdEl.textContent = ` ì„ê³„ì¹˜ ìˆ˜ì¹˜: ${latest.threshold}`;

        // ê·¸ë˜í”„ ìƒì„± or ì—…ë°ì´íŠ¸
        if (!chart) {
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: "Error ìˆ˜ì¹˜",
                data: errors,
                borderColor: "#32CD32",
                backgroundColor: "#d4ffd4",
                fill: false
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: "ì‹œê°„" } },
                y: { title: { display: true, text: "Error" }, beginAtZero: true }
              },
              plugins: {
                annotation: {
                  annotations: {
                    thresholdLine: {
                      type: 'line',
                      yMin: latest.threshold,
                      yMax: latest.threshold,
                      borderColor: 'black',
                      borderWidth: 2,
                      borderDash: [4, 4],
                    }
                  }
                }
              }
            }
          });
        } else {
          chart.data.labels = labels;
          chart.data.datasets[0].data = errors;
          chart.update();
        }

        // ìš”ì•½ ì •ë³´
        const avgError = (errors.reduce((a, b) => a + b, 0) / errors.length).toFixed(3);
        const avgThreshold = (data.map(d => d.threshold).reduce((a, b) => a + b, 0) / data.length).toFixed(3);
        const predictCount = data.filter(d => d.predict === 1).length;
        summaryEl.innerHTML = `
          í‰ê·  ì—ëŸ¬: <b>${avgError}</b><br>
          ì´ìƒ íƒì§€ íšŸìˆ˜: <b>${predictCount}</b>
        `;

        // ë¡œê·¸ í…Œì´ë¸”
        logTableBody.innerHTML = "";
        data.slice(0, 10).forEach(d => {
          const row = `
            <tr>
              <td>${new Date(d.timestamp).toLocaleString()}</td>
              <td>${d.error.toFixed(3)}</td>
              <td>${d.predict === 1 ? 'ì´ìƒ' : 'ì •ìƒ'}</td>
            </tr>`;
          logTableBody.innerHTML += row;
        });

      } catch (err) {
        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
      }
    }

    deviceSelect.addEventListener("change", fetchData);

    window.addEventListener("DOMContentLoaded", async () => {
      await loadDeviceIds();
      fetchData();
      setInterval(fetchData, 5000);
    });
</script>
</body>
</html>